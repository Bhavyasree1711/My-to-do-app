<!DOCTYPE html>
<html>
<head>
  <title>My Firebase Todo App</title>
  
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f4f4f4;
    }
    #app-container {
      max-width: 500px;
      margin: 0 auto;
      padding: 20px;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    input[type="text"], input[type="email"], input[type="password"] {
      width: calc(100% - 22px);
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    button {
      padding: 10px 15px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 5px; /* Add some space between buttons */
    }
    button:hover {
      background-color: #0056b3;
    }
    #signOutBtn {
      background-color: #dc3545;
    }
    hr {
      border: 0;
      border-top: 1px solid #eee;
      margin: 20px 0;
    }
    ul {
      list-style-type: none;
      padding: 0;
    }
    li {
      padding: 10px;
      background-color: #f9f9f9;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    li.complete span {
      text-decoration: line-through;
      color: #888;
    }
    .todo-text {
      cursor: pointer;
      flex-grow: 1;
    }
    .delete-btn {
      background-color: #ff4d4d;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
    }
    .back-btn {
      background-color: #6c757d; /* A neutral gray */
    }
    .back-btn:hover {
      background-color: #5a6268;
    }
  </style>
</head>
<body>

  <div id="app-container">
    <h1>My Firebase Todo App</h1>

    <div id="auth-container">
      
      <div id="auth-choice">
        <button id="showLoginBtn">Login</button>
        <button id="showSignUpBtn">Sign Up</button>
      </div>
    
      <div id="login-form-container" style="display: none;">
        <h3>Login</h3>
        <input type="email" id="loginEmail" placeholder="Email" />
        <input type="password" id="loginPassword" placeholder="Password" />
        <button id="loginBtn">Login</button>
        <button class="back-btn">Back</button>
      </div>
    
      <div id="signup-form-container" style="display: none;">
        <h3>Sign Up</h3>
        <input type="email" id="signUpEmail" placeholder="Email" />
        <input type="password" id="signUpPassword" placeholder="Password" />
        <button id="signUpBtn">Sign Up</button>
        <button class="back-btn">Back</button>
      </div>

    </div>

    <div id="user-info" style="display: none;">
      <p>Welcome, <span id="userEmail"></span>!</p>
      <button id="signOutBtn">Sign Out</button>
    </div>

    <hr>

    <div id="todo-container" style="display: none;">
      <input type="text" id="todoInput" placeholder="Add a new todo" />
      <button id="addTodoBtn">Add Todo</button>
      <ul id="todoList">
        </ul>
    </div>

  </div> <script type="module">
    // --- (IMPORTS) ---
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.7/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.6.7/firebase-analytics.js";
    
    // Import Firestore functions
    import { 
      getFirestore, collection, addDoc, onSnapshot,
      query, orderBy, doc, deleteDoc, updateDoc, where
    } from "https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore.js";

    // Import Auth functions
    import { 
      getAuth, 
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      signOut,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/9.6.7/firebase-auth.js";

    // --- (CONFIG & INIT) ---
    
    // Your web app's Firebase configuration (FROM YOUR PASTE)
    const firebaseConfig = {
      apiKey: "AIzaSyCEgHnBlcnLMn5bBcz2S_0219tQqXs90Ng",
      authDomain: "my-first-app-3fc3a.firebaseapp.com",
      projectId: "my-first-app-3fc3a",
      storageBucket: "my-first-app-3fc3a.firebasestorage.app",
      messagingSenderId: "50753827321",
      appId: "1:50753827321:web:57d24e3ea3d579a1654d28",
      measurementId: "G-6RMWE2MLR2"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    // Initialize all the services we need
    const db = getFirestore(app);
    const auth = getAuth(app);
    const analytics = getAnalytics(app);
    
    console.log("Firebase, Firestore, and Auth are connected!");

    // --- (APP STATE) ---
    let currentUser = null;
    let unsubscribeTodos = null;
    
    // --- (ELEMENT REFS) ---
    // Auth elements
    const authContainer = document.getElementById("auth-container");
    const userInfo = document.getElementById("user-info");
    const userEmail = document.getElementById("userEmail");
    const signOutBtn = document.getElementById("signOutBtn");
    
    // UI Elements
    const authChoice = document.getElementById("auth-choice");
    const loginFormContainer = document.getElementById("login-form-container");
    const signupFormContainer = document.getElementById("signup-form-container");
    const showLoginBtn = document.getElementById("showLoginBtn");
    const showSignUpBtn = document.getElementById("showSignUpBtn");
    const backBtns = document.querySelectorAll(".back-btn");

    // Auth form elements
    const signUpEmail = document.getElementById("signUpEmail");
    const signUpPassword = document.getElementById("signUpPassword");
    const signUpBtn = document.getElementById("signUpBtn");
    const loginEmail = document.getElementById("loginEmail");
    const loginPassword = document.getElementById("loginPassword");
    const loginBtn = document.getElementById("loginBtn");
    
    // Todo elements
    const todoContainer = document.getElementById("todo-container");
    const todoInput = document.getElementById("todoInput");
    const addTodoBtn = document.getElementById("addTodoBtn");
    const todoList = document.getElementById("todoList");
    
    // --- (TODO APP: CRUD Logic) ---
    
    // (CREATE)
    addTodoBtn.addEventListener("click", async () => {
      const text = todoInput.value;
      if (text === "" || !currentUser) return;
      try {
        await addDoc(collection(db, "todos"), {
          text: text,
          status: "pending",
          createdAt: new Date(),
          userId: currentUser.uid
        });
        todoInput.value = "";
      } catch (e) { console.error("Error adding document: ", e); }
    });

    // (READ)
    function getTodos(uid) {
      const q = query(
        collection(db, "todos"), 
        where("userId", "==", uid),
        orderBy("createdAt", "desc")
      );
      unsubscribeTodos = onSnapshot(q, (querySnapshot) => {
        todoList.innerHTML = "";
        querySnapshot.forEach((doc) => {
          const todo = doc.data();
          const li = document.createElement("li");
          li.dataset.id = doc.id;
          if (todo.status === "complete") {
            li.classList.add("complete");
          }
          li.innerHTML = `
            <span class="todo-text">${todo.text}</span>
            <button class="delete-btn">Delete</button>
          `;
          todoList.appendChild(li);
        });
      });
    }

    // (UPDATE & DELETE)
    todoList.addEventListener("click", async (e) => {
      const li = e.target.closest("li");
      if (!li) return;
      const id = li.dataset.id;
      const docRef = doc(db, "todos", id);

      if (e.target.classList.contains("delete-btn")) {
        try { await deleteDoc(docRef); } 
        catch (e) { console.error("Error deleting document: ", e); }
      }
      else if (e.target.classList.contains("todo-text")) {
        const newStatus = li.classList.contains("complete") ? "pending" : "complete";
        try { await updateDoc(docRef, { status: newStatus }); }
        catch (e) { console.error("Error updating document: ", e); }
      }
    });

    // --- (AUTH & UI Listeners) ---

    // UI Listeners
    showLoginBtn.addEventListener("click", () => {
      authChoice.style.display = "none";
      loginFormContainer.style.display = "block";
    });

    showSignUpBtn.addEventListener("click", () => {
      authChoice.style.display = "none";
      signupFormContainer.style.display = "block";
    });

    backBtns.forEach(btn => {
      btn.addEventListener("click", () => {
        authChoice.style.display = "block";
        loginFormContainer.style.display = "none";
        signupFormContainer.style.display = "none";
      });
    });
    
    // Sign Up
    signUpBtn.addEventListener("click", async () => {
      const email = signUpEmail.value;
      const password = signUpPassword.value;
      try {
        await createUserWithEmailAndPassword(auth, email, password);
      } catch (error) {
        console.error("Error signing up:", error.message);
        alert(error.message);
      }
    });
    
    // Login
    loginBtn.addEventListener("click", async () => {
      const email = loginEmail.value;
      const password = loginPassword.value;
      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (error) {
        console.error("Error logging in:", error.message);
        alert(error.message);
      }
    });

    // Sign Out
    signOutBtn.addEventListener("click", async () => {
       try {
        await signOut(auth);
       } catch (error) { console.error("Error signing out:", error.message); }
    });
    
    // Auth State Listener: This controls what you see
    onAuthStateChanged(auth, (user) => {
      if (user) {
        // User is signed in
        currentUser = user;
        authContainer.style.display = "none";
        userInfo.style.display = "block";
        todoContainer.style.display = "block";
      
        userEmail.textContent = user.email;
        getTodos(user.uid);
      } else {
        // User is signed out
        currentUser = null;
        authContainer.style.display = "block";
        userInfo.style.display = "none";
        todoContainer.style.display = "none";
        
        // Reset auth UI to the starting choice
        authChoice.style.display = "block";
        loginFormContainer.style.display = "none";
        signupFormContainer.style.display = "none";
        
        userEmail.textContent = "";
        
        if (unsubscribeTodos) {
          unsubscribeTodos();
        }
        
        todoList.innerHTML = "";
      }
    });

  </script>

</body>
</html>